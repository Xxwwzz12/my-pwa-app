<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="/service-worker-registration.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        #subscribeBtn {
            background-color: #3498db;
            color: white;
        }
        
        #subscribeBtn:hover {
            background-color: #2980b9;
        }
        
        #sendBtn {
            background-color: #2ecc71;
            color: white;
        }
        
        #sendBtn:hover {
            background-color: #27ae60;
        }
        
        #sendBtn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .status-panel {
            background-color: #f1f8ff;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        #status {
            font-size: 16px;
            line-height: 1.5;
        }
        
        .log-container {
            margin-top: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
        }
        
        #log {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        .warning { color: #f39c12; }
        
        .support-check {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>
        
        <div class="support-check">
            <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º:</h3>
            <div id="supportStatus">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</div>
        </div>
        
        <div class="button-group">
            <button id="subscribeBtn">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        </div>
        
        <div class="status-panel">
            <h3>–°—Ç–∞—Ç—É—Å:</h3>
            <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...</div>
        </div>
        
        <div class="log-container">
            <h3>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π:</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const statusDiv = document.getElementById('status');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const sendBtn = document.getElementById('sendBtn');
        const supportStatusDiv = document.getElementById('supportStatus');
        const logDiv = document.getElementById('log');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let swRegistration = null;
        let isSubscribed = false;
        let vapidPublicKey = null;
        let currentSubscription = null; // –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É

        // FIX: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const savedSubscription = localStorage.getItem('pushSubscription');
        if (savedSubscription) {
            try {
                currentSubscription = JSON.parse(savedSubscription);
                statusDiv.textContent = '–°—Ç–∞—Ç—É—Å: –ü–æ–¥–ø–∏—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –∫—ç—à–∞!';
                sendBtn.disabled = false;
                addLog('–ü–æ–¥–ø–∏—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ localStorage', 'success');
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${e.message}`, 'error');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
        function addLog(message, className = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = className;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
        function checkBrowserSupport() {
            const supported = 'serviceWorker' in navigator && 'PushManager' in window;
            
            if (!supported) {
                supportStatusDiv.innerHTML = `
                    <div class="error">‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</div>
                    <ul>
                        <li>Service Workers: ${'serviceWorker' in navigator ? '‚úÖ' : '‚ùå'}</li>
                        <li>Push API: ${'PushManager' in window ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                `;
                
                subscribeBtn.disabled = true;
                addLog('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Service Workers –∏/–∏–ª–∏ Push API', 'error');
            } else {
                supportStatusDiv.innerHTML = '<div class="success">‚úÖ –í–∞—à –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</div>';
                addLog('–ë—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏');
            }
            
            return supported;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function init() {
            if (!checkBrowserSupport()) return;
            
            try {
                addLog('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker...');
                swRegistration = await navigator.serviceWorker.register('/sw.js');
                
                addLog(`Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å –æ–±–ª–∞—Å—Ç—å—é: ${swRegistration.scope}`);
                statusDiv.textContent = 'Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏...';
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                await checkSubscription();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                checkNotificationPermission();
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker: ${error.message}`, 'error');
                statusDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        async function checkSubscription() {
            try {
                const subscription = await swRegistration.pushManager.getSubscription();
                isSubscribed = !(subscription === null);
                
                if (isSubscribed) {
                    // FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
                    currentSubscription = subscription;
                    addLog('–ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞', 'success');
                    statusDiv.textContent = '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.';
                    sendBtn.disabled = false;
                    subscribeBtn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π';
                    
                    // FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                } else {
                    addLog('–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'info');
                    statusDiv.textContent = '–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.';
                    subscribeBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                }
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, 'error');
                statusDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function checkNotificationPermission() {
            if (Notification.permission === 'granted') {
                addLog('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');
            } else if (Notification.permission === 'denied') {
                addLog('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ', 'warning');
                statusDiv.textContent = '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.';
                subscribeBtn.disabled = true;
            }
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞
        subscribeBtn.addEventListener('click', async () => {
            if (isSubscribed) {
                await unsubscribe();
            } else {
                await subscribe();
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        sendBtn.addEventListener('click', async () => {
            addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
            statusDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...';
            
            try {
                // FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—É—Ç—å –∫ API
                const response = await fetch('/api/notifications/send-push', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cookie': `connect.sid=${getSessionCookie()}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        // FIX: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                        subscription: currentSubscription,
                        title: "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
                        body: "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç! üéâ",
                        icon: "/images/assets/icon-message.webp"
                    })
                });
                
                if (response.ok) {
                    addLog('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                    statusDiv.textContent = '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.';
                } else {
                    // FIX: –ß—Ç–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ JSON-–æ—Ç–≤–µ—Ç–∞
                    const errorData = await response.json();
                    const errorMessage = errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`;
                    throw new Error(errorMessage);
                }
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
                statusDiv.textContent = `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`;
                
                // FIX: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                if (error.message.includes('404')) {
                    addLog('–°–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞.', 'error');
                }
            }
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–π –∫—É–∫–∏
        function getSessionCookie() {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'connect.sid') {
                    return value;
                }
            }
            return '';
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        async function subscribe() {
            try {
                addLog('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
                statusDiv.textContent = '–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...';
                
                const permission = await Notification.requestPermission();
                addLog(`–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${permission}`);
                
                if (permission !== 'granted') {
                    throw new Error('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                }
                
                addLog('–ü–æ–ª—É—á–µ–Ω–∏–µ VAPID-–∫–ª—é—á–∞ –æ—Ç Service Worker...');
                statusDiv.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞...';
                
                vapidPublicKey = await getVAPIDKey();
                
                addLog('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ...');
                statusDiv.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏...';
                
                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });
                
                // FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
                currentSubscription = subscription;
                
                addLog('–ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...');
                statusDiv.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏...';
                
                await saveSubscription(subscription);
                
                isSubscribed = true;
                sendBtn.disabled = false;
                subscribeBtn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                
                // FIX: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('pushSubscription', JSON.stringify(subscription));
                
                addLog('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!', 'success');
                statusDiv.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!';
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, 'error');
                statusDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏
        async function unsubscribe() {
            try {
                addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø–∏—Å–∫–∏...');
                statusDiv.textContent = '–û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏...';
                
                const subscription = await swRegistration.pushManager.getSubscription();
                if (subscription) {
                    await subscription.unsubscribe();
                    addLog('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ', 'success');
                    
                    // FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
                    const response = await fetch('/api/notifications/save-subscription', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cookie': `connect.sid=${getSessionCookie()}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({ subscription: null })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                    }
                    
                    addLog('–ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞', 'success');
                }
                
                isSubscribed = false;
                sendBtn.disabled = true;
                subscribeBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                
                // FIX: –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
                localStorage.removeItem('pushSubscription');
                currentSubscription = null;
                
                addLog('–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'success');
                statusDiv.textContent = '–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.';
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ—Ç–ø–∏—Å–∫–∏: ${error.message}`, 'error');
                statusDiv.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ VAPID-–∫–ª—é—á–∞ –æ—Ç SW
        async function getVAPIDKey() {
            return new Promise((resolve, reject) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = event => {
                    if (event.data && event.data.type === 'VAPID_KEY') {
                        resolve(event.data.key);
                    } else {
                        reject('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å VAPID-–∫–ª—é—á');
                    }
                };
                
                if (!navigator.serviceWorker.controller) {
                    reject('Service Worker –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                    return;
                }
                
                navigator.serviceWorker.controller.postMessage(
                    { type: 'GET_VAPID_KEY' },
                    [messageChannel.port2]
                );
                
                // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—Ç–≤–µ—Ç–∞
                setTimeout(() => {
                    reject('–¢–∞–π–º–∞—É—Ç –ø–æ–ª—É—á–µ–Ω–∏—è VAPID-–∫–ª—é—á–∞');
                }, 5000);
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        async function saveSubscription(subscription) {
            try {
                const response = await fetch('/api/notifications/save-subscription', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cookie': `connect.sid=${getSessionCookie()}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({ subscription })
                });
                
                if (!response.ok) {
                    // FIX: –ß—Ç–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ JSON-–æ—Ç–≤–µ—Ç–∞
                    const errorData = await response.json();
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                
                addLog('–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
                return true;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ${error.message}`, 'error');
                throw error;
            }
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–ª—é—á–∞
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', init);
        } else {
            supportStatusDiv.innerHTML = '<div class="error">‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Service Workers</div>';
            addLog('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Service Workers', 'error');
        }
    </script>
</body>
</html>
